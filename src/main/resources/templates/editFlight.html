<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
  <title th:text="${isEdit} ? 'Редактировать рейс' : 'Добавить рейс'">Редактировать рейс</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <style>
    .main-content {
      margin-bottom: 100px;
      padding-top: 20px;
    }
    .form-card {
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 15px;
    }
    .required {
      color: red;
    }
    .time-input {
      position: relative;
    }
  </style>
</head>
<body>

<div th:replace="general :: page-header"></div>

<div class="main-content">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card form-card">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0" th:text="${isEdit} ? 'Редактировать рейс' : 'Добавить новый рейс'"></h4>
          </div>
          <div class="card-body p-4">
            <form method="post" action="/saveFlight" id="flightForm" class="needs-validation" novalidate>
              <input type="hidden" name="flightId" th:value="${flight.id}" th:if="${isEdit}">

              <!-- Flight Information -->
              <div class="row">
                <div class="col-12">
                  <h5 class="mb-3">Информация о рейсе</h5>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="flightNumber">Номер рейса <span class="required">*</span></label>
                    <input type="text" class="form-control" id="flightNumber" name="flightNumber"
                           th:value="${flight.flightNumber}" required maxlength="10"
                           placeholder="SU123, S7456, etc."
                           pattern="[A-Z0-9]{2,10}">
                    <div class="invalid-feedback">
                      Пожалуйста, введите номер рейса (2-10 символов).
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="airlineId">Авиакомпания <span class="required">*</span></label>
                    <select class="form-control" id="airlineId" name="airlineId" required>
                      <option value="">Выберите авиакомпанию</option>
                      <option th:each="airline : ${airlines}"
                              th:value="${airline.id}"
                              th:text="${airline.name}"
                              th:selected="${flight.airline != null && flight.airline.id == airline.id}">
                      </option>
                    </select>
                    <div class="invalid-feedback">
                      Пожалуйста, выберите авиакомпанию.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Route Information -->
              <div class="row">
                <div class="col-12">
                  <h5 class="mb-3">Маршрут</h5>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="departureAirport">Аэропорт вылета <span class="required">*</span></label>
                    <select class="form-control" id="departureAirport" name="departureAirport" required>
                      <option value="">Выберите аэропорт вылета</option>
                      <option value="SVO" th:selected="${flight.departureAirport == 'SVO'}">Москва (SVO) - Шереметьево</option>
                      <option value="DME" th:selected="${flight.departureAirport == 'DME'}">Москва (DME) - Домодедово</option>
                      <option value="VKO" th:selected="${flight.departureAirport == 'VKO'}">Москва (VKO) - Внуково</option>
                      <option value="LED" th:selected="${flight.departureAirport == 'LED'}">Санкт-Петербург (LED) - Пулково</option>
                      <option value="KZN" th:selected="${flight.departureAirport == 'KZN'}">Казань (KZN)</option>
                      <option value="SVX" th:selected="${flight.departureAirport == 'SVX'}">Екатеринбург (SVX)</option>
                      <option value="ROV" th:selected="${flight.departureAirport == 'ROV'}">Ростов-на-Дону (ROV)</option>
                      <option value="OVB" th:selected="${flight.departureAirport == 'OVB'}">Новосибирск (OVB)</option>
                    </select>
                    <div class="invalid-feedback">
                      Пожалуйста, выберите аэропорт вылета.
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="arrivalAirport">Аэропорт прилета <span class="required">*</span></label>
                    <select class="form-control" id="arrivalAirport" name="arrivalAirport" required>
                      <option value="">Выберите аэропорт прилета</option>
                      <option value="SVO" th:selected="${flight.arrivalAirport == 'SVO'}">Москва (SVO) - Шереметьево</option>
                      <option value="DME" th:selected="${flight.arrivalAirport == 'DME'}">Москва (DME) - Домодедово</option>
                      <option value="VKO" th:selected="${flight.arrivalAirport == 'VKO'}">Москва (VKO) - Внуково</option>
                      <option value="LED" th:selected="${flight.arrivalAirport == 'LED'}">Санкт-Петербург (LED) - Пулково</option>
                      <option value="KZN" th:selected="${flight.arrivalAirport == 'KZN'}">Казань (KZN)</option>
                      <option value="SVX" th:selected="${flight.arrivalAirport == 'SVX'}">Екатеринбург (SVX)</option>
                      <option value="ROV" th:selected="${flight.arrivalAirport == 'ROV'}">Ростов-на-Дону (ROV)</option>
                      <option value="OVB" th:selected="${flight.arrivalAirport == 'OVB'}">Новосибирск (OVB)</option>
                    </select>
                    <div class="invalid-feedback">
                      Пожалуйста, выберите аэропорт прилета.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Schedule Information -->
              <div class="row">
                <div class="col-12">
                  <h5 class="mb-3">Расписание</h5>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="departureTime">Дата и время вылета <span class="required">*</span></label>
                    <input type="datetime-local" class="form-control" id="departureTime" name="departureTime"
                           th:value="${flight.departureTime != null ? #temporals.format(flight.departureTime, 'yyyy-MM-dd\'T\'HH:mm') : ''}"
                           required>
                    <div class="invalid-feedback">
                      Пожалуйста, выберите дату и время вылета.
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="arrivalTime">Дата и время прилета <span class="required">*</span></label>
                    <input type="datetime-local" class="form-control" id="arrivalTime" name="arrivalTime"
                           th:value="${flight.arrivalTime != null ? #temporals.format(flight.arrivalTime, 'yyyy-MM-dd\'T\'HH:mm') : ''}"
                           required>
                    <div class="invalid-feedback">
                      Пожалуйста, выберите дату и время прилета.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pricing and Capacity -->
              <div class="row">
                <div class="col-12">
                  <h5 class="mb-3">Цена и вместимость</h5>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="price">Цена билета (₽) <span class="required">*</span></label>
                    <input type="number" class="form-control" id="price" name="price"
                           th:value="${flight.price}" required min="0" step="0.01"
                           placeholder="5000.00">
                    <div class="invalid-feedback">
                      Пожалуйста, введите корректную цену.
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="totalSeats">Общее количество мест <span class="required">*</span></label>
                    <input type="number" class="form-control" id="totalSeats" name="totalSeats"
                           th:value="${flight.totalSeats}" required min="1" max="1000"
                           placeholder="180">
                    <div class="invalid-feedback">
                      Пожалуйста, введите количество мест (1-1000).
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="availableSeats">Доступно мест <span class="required">*</span></label>
                    <input type="number" class="form-control" id="availableSeats" name="availableSeats"
                           th:value="${flight.availableSeats}" required min="0"
                           placeholder="180">
                    <div class="invalid-feedback">
                      Доступных мест не может быть больше общего количества.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Action buttons -->
              <div class="form-group text-center mt-4">
                <button type="submit" class="btn btn-success btn-lg mr-3">
                  <i class="fas fa-save"></i>
                  <span th:text="${isEdit} ? 'Сохранить изменения' : 'Создать рейс'"></span>
                </button>
                <a th:href="${isEdit} ? '/flight?flightId=' + ${flight.id} : '/flights'"
                   class="btn btn-secondary btn-lg">
                  <i class="fas fa-times"></i> Отмена
                </a>
              </div>
            </form>
          </div>
        </div>

        <!-- Help Card -->
        <div class="card mt-4">
          <div class="card-body">
            <h6 class="card-title">Справка</h6>
            <ul class="mb-0 small">
              <li>Поля, отмеченные звездочкой (<span class="required">*</span>), обязательны для заполнения</li>
              <li>Номер рейса должен быть уникальным</li>
              <li>Время прилета должно быть позже времени вылета</li>
              <li>Доступных мест не может быть больше общего количества</li>
              <li>Аэропорты вылета и прилета должны отличаться</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div th:replace="general :: site-footer"></div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div th:replace="general :: site-script"></div>

<script>
  // Form validation
  (function() {
    'use strict';
    window.addEventListener('load', function() {
      var form = document.getElementById('flightForm');
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    }, false);
  })();

  // Prevent same departure and arrival airports
  function validateAirports() {
    const departure = document.getElementById('departureAirport').value;
    const arrival = document.getElementById('arrivalAirport').value;

    if (departure && arrival && departure === arrival) {
      alert('Аэропорты вылета и прилета не могут совпадать!');
      document.getElementById('arrivalAirport').value = '';
    }
  }

  document.getElementById('departureAirport').addEventListener('change', validateAirports);
  document.getElementById('arrivalAirport').addEventListener('change', validateAirports);

  // Validate available seats against total seats
  function validateSeats() {
    const totalSeats = parseInt(document.getElementById('totalSeats').value) || 0;
    const availableSeats = parseInt(document.getElementById('availableSeats').value) || 0;
    const availableInput = document.getElementById('availableSeats');

    if (availableSeats > totalSeats) {
      availableInput.setCustomValidity('Доступных мест не может быть больше общего количества');
    } else {
      availableInput.setCustomValidity('');
    }
  }

  document.getElementById('totalSeats').addEventListener('input', function() {
    const availableInput = document.getElementById('availableSeats');
    availableInput.max = this.value;
    validateSeats();
  });

  document.getElementById('availableSeats').addEventListener('input', validateSeats);

  // Validate departure and arrival times
  function validateTimes() {
    const departureTime = document.getElementById('departureTime').value;
    const arrivalTime = document.getElementById('arrivalTime').value;
    const arrivalInput = document.getElementById('arrivalTime');

    if (departureTime && arrivalTime) {
      const departure = new Date(departureTime);
      const arrival = new Date(arrivalTime);

      if (arrival <= departure) {
        arrivalInput.setCustomValidity('Время прилета должно быть позже времени вылета');
      } else {
        arrivalInput.setCustomValidity('');
      }
    }
  }

  document.getElementById('departureTime').addEventListener('change', validateTimes);
  document.getElementById('arrivalTime').addEventListener('change', validateTimes);

  // Set minimum datetime to current time
  document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const minDateTime = now.toISOString().slice(0, 16);
    document.getElementById('departureTime').min = minDateTime;
    document.getElementById('arrivalTime').min = minDateTime;
  });

  // Auto-sync available seats with total seats for new flights
  document.getElementById('totalSeats').addEventListener('input', function() {
    const availableSeatsInput = document.getElementById('availableSeats');
    if (!availableSeatsInput.value || availableSeatsInput.value === '0') {
      availableSeatsInput.value = this.value;
    }
  });

  // Flight number formatting
  document.getElementById('flightNumber').addEventListener('input', function(e) {
    e.target.value = e.target.value.toUpperCase();
  });
</script>

</body>
</html>