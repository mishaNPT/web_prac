<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
  <title th:text="'Клиент: ' + ${client.fullName}">Информация о клиенте</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <style>
    .main-content {
      margin-bottom: 100px;
      padding-top: 20px;
    }
    .client-header {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }
    .miles-display {
      background-color: #007bff;
      color: white;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }
    .booking-card {
      transition: transform 0.2s ease;
      margin-bottom: 15px;
    }
    .booking-card:hover {
      transform: translateY(-2px);
    }
  </style>
</head>
<body>

<div th:replace="~{general :: page-header}"></div>

<div class="main-content">
  <div class="container">
    <!-- Client Header -->
    <div class="client-header">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h2 class="mb-2" th:text="${client.fullName}"></h2>
          <div class="row">
            <div class="col-md-6" th:if="${client.email}">
              <p class="mb-1"><i class="fas fa-envelope mr-2"></i><span th:text="${client.email}"></span></p>
            </div>
            <div class="col-md-6" th:if="${client.phone}">
              <p class="mb-1"><i class="fas fa-phone mr-2"></i><span th:text="${client.phone}"></span></p>
            </div>
          </div>
          <div th:if="${client.address}">
            <p class="mb-0"><i class="fas fa-map-marker-alt mr-2"></i><span th:text="${client.address}"></span></p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="miles-display">
            <h3 class="mb-1" th:text="${client.bonusMiles}"></h3>
            <p class="mb-0">бонусных миль</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="btn-toolbar justify-content-between">
          <div class="btn-group">
            <a th:href="@{/editClient(clientId=${client.id})}"
               class="btn btn-warning">
              <i class="fas fa-edit"></i> Редактировать
            </a>
            <button class="btn btn-danger" data-toggle="modal"
                    th:data-target="'#deleteModal' + ${client.id}">
              <i class="fas fa-trash"></i> Удалить
            </button>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" data-toggle="modal" data-target="#addMilesModal">
              <i class="fas fa-plus"></i> Добавить мили
            </button>
            <button class="btn btn-secondary" data-toggle="modal" data-target="#deductMilesModal"
                    th:if="${client.bonusMiles > 0}">
              <i class="fas fa-minus"></i> Списать мили
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bookings History -->
    <div class="row">
      <div class="col-12">
        <h4>История бронирований</h4>

        <!-- Empty bookings state -->
        <div th:if="${#lists.isEmpty(bookings)}" class="alert alert-info">
          <p class="mb-0">У этого клиента пока нет бронирований.</p>
        </div>

        <!-- Bookings list -->
        <div th:unless="${#lists.isEmpty(bookings)}">
          <div class="row">
            <div class="col-lg-6" th:each="booking : ${bookings}">
              <div class="card booking-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0" th:text="${booking.flight.flightNumber}"></h6>
                    <span th:if="${booking.status == 'PAID'}" class="badge badge-success">Оплачен</span>
                    <span th:if="${booking.status == 'CANCELLED'}" class="badge badge-danger">Отменен</span>
                    <span th:if="${booking.status != 'PAID' and booking.status != 'CANCELLED'}" class="badge badge-warning">Забронирован</span>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Авиакомпания:</small>
                    <span th:text="${booking.flight.airline.name}"></span>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Маршрут:</small>
                    <span th:text="${booking.flight.departureAirport} + ' → ' + ${booking.flight.arrivalAirport}"></span>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Вылет:</small>
                    <span th:text="${#temporals.format(booking.flight.departureTime, 'dd.MM.yyyy HH:mm')}"></span>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Стоимость:</small>
                    <span th:text="${#numbers.formatDecimal(booking.flight.price, 0, 'COMMA', 0, 'POINT')} + ' ₽'"></span>
                  </div>

                  <div class="mb-2">
                    <small class="text-muted">Дата бронирования:</small>
                    <span th:text="${#temporals.format(booking.bookingDate, 'dd.MM.yyyy HH:mm')}"></span>
                  </div>

                  <div th:if="${booking.paidWithMiles}" class="mb-2">
                    <span class="badge badge-info">
                      Оплачено милями: <span th:text="${booking.milesUsed}"></span>
                    </span>
                  </div>

                  <div class="mt-3">
                    <a th:href="@{/booking(bookingId=${booking.id})}"
                       class="btn btn-sm btn-outline-info">Подробнее</a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Booking Statistics -->
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">Статистика бронирований</h5>
              <div class="row">
                <div class="col-md-3">
                  <div class="text-center">
                    <h4 class="text-primary" th:text="${bookings.size()}"></h4>
                    <small class="text-muted">Всего бронирований</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center">
                    <h4 class="text-success" th:text="${#lists.size(bookings.?[status == 'PAID'])}"></h4>
                    <small class="text-muted">Оплаченных</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center">
                    <h4 class="text-warning" th:text="${#lists.size(bookings.?[paidWithMiles == true])}"></h4>
                    <small class="text-muted">Оплачено милями</small>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="text-center">
                    <h4 class="text-info" th:text="${#aggregates.sum(bookings.![milesUsed])}"></h4>
                    <small class="text-muted">Потрачено миль</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Miles Modal -->
<div class="modal fade" id="addMilesModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Добавить бонусные мили</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <form method="post" action="/addMiles">
        <div class="modal-body">
          <input type="hidden" name="clientId" th:value="${client.id}">
          <div class="form-group">
            <label for="addMilesAmount">Количество миль для добавления:</label>
            <input type="number" class="form-control" id="addMilesAmount" name="miles"
                   min="1" max="100000" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-success">Добавить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Deduct Miles Modal -->
<div class="modal fade" id="deductMilesModal" tabindex="-1" th:if="${client.bonusMiles > 0}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Списать бонусные мили</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <form method="post" action="/deductMiles">
        <div class="modal-body">
          <input type="hidden" name="clientId" th:value="${client.id}">
          <div class="form-group">
            <label for="deductMilesAmount">Количество миль для списания:</label>
            <input type="number" class="form-control" id="deductMilesAmount" name="miles"
                   th:min="1" th:max="${client.bonusMiles}" required>
            <small class="form-text text-muted">
              Доступно для списания: <span th:text="${client.bonusMiles}"></span> миль
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-warning">Списать</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Client Modal -->
<div class="modal fade" th:id="'deleteModal' + ${client.id}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Подтверждение удаления</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Вы уверены, что хотите удалить клиента <strong th:text="${client.fullName}"></strong>?</p>
        <p class="text-danger"><small>Это действие нельзя отменить. Все связанные бронирования также будут удалены.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
        <form method="post" action="/deleteClient" style="display: inline;">
          <input type="hidden" name="clientId" th:value="${client.id}">
          <button type="submit" class="btn btn-danger">Удалить</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div th:replace="~{general :: site-footer}"></div>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<div th:replace="~{general :: site-script}"></div>

</body>
</html>